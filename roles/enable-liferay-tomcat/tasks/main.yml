
- name: link the current liferay version to default path
  file:
    state: link
    src: '{{ remotedirs.service }}/{{ app__liferay__name }}'
    dest: '{{ app__liferay__worklink }}'
    force: True

- name: check whether the old webapps was already disabled once
  stat:
    path: '/var/lib/{{ app__tomcat__name }}/webapps_ansible_disabled'
  register: tomcat_webapps_stat

- name: stop tomcat
  service:
    name: '{{ app__tomcat__name }}'
    state: stopped

- name: move the old tomcat webapps out of the way
  when: not tomcat_webapps_stat.stat.exists
  command: mv '/var/lib/{{ app__tomcat__name }}/webapps' '/var/lib/{{ app__tomcat__name }}/webapps_ansible_disabled'

- name: link liferay webapps into tomcat directory
  when: not tomcat_webapps_stat.stat.exists
  file:
    state: link
    dest: '/var/lib/{{ app__tomcat__name }}/webapps'
    src: '{{ app__liferay__workdir }}'

#- name: link liferay portal properties to system lib
#  file:
#    state: link
#    dest: '/var/lib/portal-ext.properties'
#    src: '{{ app__liferay__workdir }}'
#TODO still needed?

#- name: edit the main tomcat server.xml
#  blockinfile:
#    dest: '{{ app__tomcat__config }}'
#    regexp: '
#    replace: '        <!-- {mark} ANSIBLE MANAGED BLOCK -->
#      <Host name="localhost"  appBase="{{  }}"
#            unpackWARs="true" autoDeploy="true">

- name: start tomcat
  service:
    name: '{{ app__tomcat__name }}'
    state: stopped

